# clipmuxd

**clipmuxd** — это фоновый сервис, который принимает и отправляет буферы обмена другим устройствам.

⚠️ **Проект в разработке**
В данный момент проект находится в активной разработке. Функционал и API могут изменяться.

## Описание работы

- **clipmuxd** работает в фоне и управляет буферами обмена, синхронизируя их между устройствами.
- **UI-программы** подключаются к локальному сервису clipmuxd, чтобы отдавать команды и получать данные о текущем состоянии буфера обмена.

## Особенности

- При первом запуске приложения автоматически генерируются SSL-сертификаты для клиента (UI) и сервиса clipmuxd.
- Эти сертификаты используются для установки защищённого соединения UI → локальный clipmuxd через Unix сокеты или Named Pipes с использованием технологии mTLS (взаимная TLS-аутентификация).
- Обмен сертификатами происходит на этапе handshake при установлении соединений.
- Тот же ключ clipmuxd применяется для установки защищённых соединений между разными устройствами.

## Порты по умолчанию

- `51523` — gRPC handshake (установление защищённого соединения между устройствами)
- `63482` — основной gRPC-канал для передачи буфера и команд
- `49876` — обнаружение устройств в сети (network discovery, UDP)

- Для локального подключения UI:
  - Unix сокет: `/run/clipmuxd.sock` (Linux)
  - Named Pipe: `\\.\pipe\clipmuxd` (Windows)

---

clipmuxd обеспечивает безопасный обмен буферами и синхронизацию данных между локальными приложениями и удалёнными устройствами.

```
+------------------+                                         +---------------------+
| Инициатор (A)    |                                         | Принимающий (B)      |
+------------------+                                         +---------------------+
        |                                                        |
        | --- InitHandshake(PubKeyA, UUID_A, Nonce) ------------>|
        |                                                        |
        | <--------- InitHandshake(PubKeyB, UUID_B) -------------|
        |                                                        |
        |           Проверка UUID_A в B:                          |
        |           Если есть — B отменяет сессию                 |
        |                                                        |
        |           Проверка UUID_B в A:                          |
        |           Если есть — A отправляет CancelSession(UUID_B) |
        |                                                        |
        | --- Генерация shared_key = DH(PrivA, PubB) ------------>|
        |                                                        |
        | --- Отправка Code(nonce) — сигнал показать код -------->|
        |                                                        |
        |                              Отображение кода:         |
        |                              code_B = SHA256(shared_key)[:N]  |
        |                                                        |
        |                      Пользователь вводит код на A      |
        |                                                        |
        | --- Локальная генерация code_A = SHA256(shared_key)[:N] |
        |                                                        |
        | --- Сравнение введённого кода с code_A:                |
        |         - если не совпадает — отмена сессии             |
        |         - если совпадает — продолжаем                    |
        |                                                        |
        | --- A отправляет зашифрованные JWT_A и CertA ---------->|
        |          (шифрование с использованием shared_key)       |
        |                                                        |
        |           B расшифровывает и добавляет JWT_A и CertA    |
        |           в списки доверенных                           |
        |                                                        |
        | <--- B отправляет зашифрованные JWT_B и CertB ----------|
        |          (шифрование с использованием shared_key)       |
        |                                                        |
        |           A расшифровывает и добавляет JWT_B и CertB    |
        |           в списки доверенных                           |
        |                                                        |
        |                Доверие установлено, готово к mTLS      |
+------------------+                                         +---------------------+
```
